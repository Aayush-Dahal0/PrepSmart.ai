-- Enable UUIDs
create extension if not exists "uuid-ossp";

-- Users
create table if not exists users (
  id uuid primary key default uuid_generate_v4(),
  email text unique not null,
  password_hash text not null,
  created_at timestamptz not null default now()
);

-- Conversations
create table if not exists conversations (
  id uuid primary key default uuid_generate_v4(),
  user_id uuid not null references users(id) on delete cascade,
  title text not null default 'New Interview',
  domain text not null default 'general',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
create index if not exists idx_conversations_user on conversations(user_id);

-- Messages
do $$ begin
  if not exists (select 1 from pg_type where typname = 'msg_role') then
    create type msg_role as enum ('system','user','assistant');
  end if;
end $$;

create table if not exists messages (
  id uuid primary key default uuid_generate_v4(),
  conversation_id uuid not null references conversations(id) on delete cascade,
  role msg_role not null,
  content text not null,
  token_count int,
  latency_ms int,
  created_at timestamptz not null default now()
);
create index if not exists idx_messages_conv_created on messages(conversation_id, created_at);

-- Touch updated_at on conversations
create or replace function set_updated_at() returns trigger as $$
begin new.updated_at = now(); return new; end;
$$ language plpgsql;

drop trigger if exists trg_conversations_updated on conversations;
create trigger trg_conversations_updated
before update on conversations
for each row execute function set_updated_at();
